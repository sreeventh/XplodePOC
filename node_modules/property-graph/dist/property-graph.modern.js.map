{"version":3,"file":"property-graph.modern.js","sources":["../src/event-dispatcher.ts","../src/graph-edge.ts","../src/graph.ts","../src/refs.ts","../src/graph-node.ts"],"sourcesContent":["import type { Graph } from './graph.js';\nimport type { GraphNode } from './graph-node.js';\nimport type { GraphEdge } from './graph-edge.js';\n\nexport interface BaseEvent {\n\ttype: string;\n\t[attachment: string]: unknown;\n}\n\nexport interface GraphEvent extends BaseEvent {\n\ttarget: Graph<GraphNode>;\n}\n\nexport interface GraphNodeEvent extends BaseEvent {\n\ttarget: GraphNode;\n}\n\nexport interface GraphEdgeEvent extends BaseEvent {\n\ttarget: GraphEdge<GraphNode, GraphNode>;\n}\n\nexport type EventListener<E> = (event: E) => void;\n\nexport class EventDispatcher<T extends BaseEvent> {\n\tprivate _listeners = {} as Record<string, EventListener<T>[]>;\n\n\taddEventListener(type: string, listener: EventListener<T>): this {\n\t\tconst listeners = this._listeners;\n\n\t\tif (listeners[type] === undefined) {\n\t\t\tlisteners[type] = [] as EventListener<T>[];\n\t\t}\n\n\t\tif (listeners[type].indexOf(listener) === -1) {\n\t\t\tlisteners[type].push(listener);\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tremoveEventListener(type: string, listener: EventListener<T>): this {\n\t\tif (this._listeners === undefined) return this;\n\n\t\tconst listeners = this._listeners;\n\t\tconst listenerArray = listeners[type];\n\n\t\tif (listenerArray !== undefined) {\n\t\t\tconst index = listenerArray.indexOf(listener);\n\n\t\t\tif (index !== -1) {\n\t\t\t\tlistenerArray.splice(index, 1);\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tdispatchEvent(event: T): this {\n\t\tif (this._listeners === undefined) return this;\n\n\t\tconst listeners = this._listeners;\n\t\tconst listenerArray = listeners[event.type];\n\n\t\tif (listenerArray !== undefined) {\n\t\t\t// Make a copy, in case listeners are removed while iterating.\n\t\t\tconst array = listenerArray.slice(0);\n\n\t\t\tfor (let i = 0, l = array.length; i < l; i++) {\n\t\t\t\tarray[i].call(this, event as T);\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tdispose(): void {\n\t\tfor (const key in this._listeners) {\n\t\t\tdelete this._listeners[key];\n\t\t}\n\t}\n}\n","import { EventDispatcher, GraphEdgeEvent } from './event-dispatcher.js';\nimport { GraphNode } from './graph-node.js';\n\n/**\n * Represents a connection between two {@link GraphNode} resources in a {@link Graph}.\n *\n * The left node is considered the owner, and the right node the resource. The\n * owner is responsible for being able find and remove a reference to a resource, given\n * that link. The resource does not hold a reference to the link or to the owner,\n * although that reverse lookup can be done on the graph.\n */\nexport class GraphEdge<Parent extends GraphNode, Child extends GraphNode> extends EventDispatcher<GraphEdgeEvent> {\n\tprivate _disposed = false;\n\n\tconstructor(\n\t\tprivate readonly _name: string,\n\t\tprivate readonly _parent: Parent,\n\t\tprivate _child: Child,\n\t\tprivate _attributes: Record<string, unknown> = {}\n\t) {\n\t\tsuper();\n\t\tif (!_parent.isOnGraph(_child)) {\n\t\t\tthrow new Error('Cannot connect disconnected graphs.');\n\t\t}\n\t}\n\n\t/** Name. */\n\tgetName(): string {\n\t\treturn this._name;\n\t}\n\n\t/** Owner node. */\n\tgetParent(): Parent {\n\t\treturn this._parent;\n\t}\n\n\t/** Resource node. */\n\tgetChild(): Child {\n\t\treturn this._child;\n\t}\n\n\t/**\n\t * Sets the child node.\n\t *\n\t * @internal Only {@link Graph} implementations may safely call this method directly. Use\n\t * \t{@link Property.swap} or {@link Graph.swapChild} instead.\n\t */\n\tsetChild(child: Child): this {\n\t\tthis._child = child;\n\t\treturn this;\n\t}\n\n\t/** Attributes of the graph node relationship. */\n\tgetAttributes(): Record<string, unknown> {\n\t\treturn this._attributes;\n\t}\n\n\t/** Destroys a (currently intact) edge, updating both the graph and the owner. */\n\tdispose(): void {\n\t\tif (this._disposed) return;\n\t\tthis._disposed = true;\n\t\tthis.dispatchEvent({ type: 'dispose', target: this });\n\t\tsuper.dispose();\n\t}\n\n\t/** Whether this link has been destroyed. */\n\tisDisposed(): boolean {\n\t\treturn this._disposed;\n\t}\n}\n","import { EventDispatcher, GraphEdgeEvent, GraphEvent, GraphNodeEvent } from './event-dispatcher.js';\nimport { GraphEdge } from './graph-edge.js';\nimport { GraphNode } from './graph-node.js';\n\n/**\n * A graph manages a network of {@link GraphNode} nodes, connected\n * by {@link @Link} edges.\n */\nexport class Graph<T extends GraphNode> extends EventDispatcher<GraphEvent | GraphNodeEvent | GraphEdgeEvent> {\n\tprivate _emptySet: Set<GraphEdge<T, T>> = new Set();\n\n\tprivate _edges: Set<GraphEdge<T, T>> = new Set();\n\tprivate _parentEdges: Map<T, Set<GraphEdge<T, T>>> = new Map();\n\tprivate _childEdges: Map<T, Set<GraphEdge<T, T>>> = new Map();\n\n\t/** Returns a list of all parent->child edges on this graph. */\n\tpublic listEdges(): GraphEdge<T, T>[] {\n\t\treturn Array.from(this._edges);\n\t}\n\n\t/** Returns a list of all edges on the graph having the given node as their child. */\n\tpublic listParentEdges(node: T): GraphEdge<T, T>[] {\n\t\treturn Array.from(this._childEdges.get(node) || this._emptySet);\n\t}\n\n\t/** Returns a list of parent nodes for the given child node. */\n\tpublic listParents(node: T): T[] {\n\t\treturn this.listParentEdges(node).map((edge) => edge.getParent());\n\t}\n\n\t/** Returns a list of all edges on the graph having the given node as their parent. */\n\tpublic listChildEdges(node: T): GraphEdge<T, T>[] {\n\t\treturn Array.from(this._parentEdges.get(node) || this._emptySet);\n\t}\n\n\t/** Returns a list of child nodes for the given parent node. */\n\tpublic listChildren(node: T): T[] {\n\t\treturn this.listChildEdges(node).map((edge) => edge.getChild());\n\t}\n\n\tpublic disconnectParents(node: T, filter?: (n: T) => boolean): this {\n\t\tlet edges = this.listParentEdges(node);\n\t\tif (filter) {\n\t\t\tedges = edges.filter((edge) => filter(edge.getParent()));\n\t\t}\n\t\tedges.forEach((edge) => edge.dispose());\n\t\treturn this;\n\t}\n\n\t/**\n\t * Creates a {@link GraphEdge} connecting two {@link GraphNode} instances. Edge is returned\n\t * for the caller to store.\n\t * @param a Owner\n\t * @param b Resource\n\t */\n\tpublic createEdge<A extends T, B extends T>(\n\t\tname: string,\n\t\ta: A,\n\t\tb: B,\n\t\tattributes?: Record<string, unknown>\n\t): GraphEdge<A, B> {\n\t\treturn this._registerEdge(new GraphEdge(name, a, b, attributes)) as GraphEdge<A, B>;\n\t}\n\n\t/**********************************************************************************************\n\t * Internal.\n\t */\n\n\t/** @hidden */\n\tprivate _registerEdge(edge: GraphEdge<T, T>): GraphEdge<T, T> {\n\t\tthis._edges.add(edge);\n\n\t\tconst parent = edge.getParent();\n\t\tif (!this._parentEdges.has(parent)) this._parentEdges.set(parent, new Set());\n\t\tthis._parentEdges.get(parent)!.add(edge);\n\n\t\tconst child = edge.getChild();\n\t\tif (!this._childEdges.has(child)) this._childEdges.set(child, new Set());\n\t\tthis._childEdges.get(child)!.add(edge);\n\n\t\tedge.addEventListener('dispose', () => this._removeEdge(edge));\n\t\treturn edge;\n\t}\n\n\t/**\n\t * Removes the {@link GraphEdge} from the {@link Graph}. This method should only\n\t * be invoked by the onDispose() listener created in {@link _registerEdge()}. The\n\t * public method of removing an edge is {@link GraphEdge.dispose}.\n\t */\n\tprivate _removeEdge(edge: GraphEdge<T, T>): this {\n\t\tthis._edges.delete(edge);\n\t\tthis._parentEdges.get(edge.getParent())!.delete(edge);\n\t\tthis._childEdges.get(edge.getChild())!.delete(edge);\n\t\treturn this;\n\t}\n}\n","import { GraphEdge } from './graph-edge.js';\nimport { GraphNode } from './graph-node.js';\n\nexport type Ref<T extends GraphNode = GraphNode> = GraphEdge<GraphNode, T>;\n\n/**\n * An ordered collection of {@link Ref Refs}, allowing duplicates. Removing\n * a Ref is an O(n) operation — use {@link RefSet} for faster removal, if\n * duplicates are not required.\n */\nexport class RefList<T extends GraphNode = GraphNode> {\n\tlist: Ref<T>[] = [];\n\tconstructor(refs?: Ref<T>[]) {\n\t\tif (refs) {\n\t\t\tfor (const ref of refs) {\n\t\t\t\tthis.list.push(ref);\n\t\t\t}\n\t\t}\n\t}\n\tadd(ref: Ref<T>): void {\n\t\tthis.list.push(ref);\n\t}\n\tremove(ref: Ref<T>): void {\n\t\tconst index = this.list.indexOf(ref);\n\t\tif (index >= 0) this.list.splice(index, 1);\n\t}\n\tremoveChild(child: T): Ref<T>[] {\n\t\tconst refs = [] as Ref<T>[];\n\t\tfor (const ref of this.list) {\n\t\t\tif (ref.getChild() === child) {\n\t\t\t\trefs.push(ref);\n\t\t\t}\n\t\t}\n\t\tfor (const ref of refs) {\n\t\t\tthis.remove(ref);\n\t\t}\n\t\treturn refs;\n\t}\n\tlistRefsByChild(child: T): Ref<T>[] {\n\t\tconst refs = [] as Ref<T>[];\n\t\tfor (const ref of this.list) {\n\t\t\tif (ref.getChild() === child) {\n\t\t\t\trefs.push(ref);\n\t\t\t}\n\t\t}\n\t\treturn refs;\n\t}\n\tvalues(): Ref<T>[] {\n\t\treturn this.list;\n\t}\n}\n\n/**\n * An ordered collection of {@link Ref Refs}, without duplicates. Adding or\n * removing a Ref is typically O(1) or O(log(n)), and faster than\n * {@link RefList}. If support for duplicates is required, use {@link RefList}.\n */\nexport class RefSet<T extends GraphNode = GraphNode> {\n\tset = new Set<Ref<T>>();\n\tmap = new Map<T, Ref<T>>();\n\tconstructor(refs?: Ref<T>[]) {\n\t\tif (refs) {\n\t\t\tfor (const ref of refs) {\n\t\t\t\tthis.add(ref);\n\t\t\t}\n\t\t}\n\t}\n\tadd(ref: Ref<T>): void {\n\t\tconst child = ref.getChild();\n\t\tthis.removeChild(child);\n\n\t\tthis.set.add(ref);\n\t\tthis.map.set(child, ref);\n\t}\n\tremove(ref: Ref<T>): void {\n\t\tthis.set.delete(ref);\n\t\tthis.map.delete(ref.getChild());\n\t}\n\tremoveChild(child: T): Ref<T> | null {\n\t\tconst ref = this.map.get(child) || null;\n\t\tif (ref) this.remove(ref);\n\t\treturn ref;\n\t}\n\tgetRefByChild(child: T): Ref<T> | null {\n\t\treturn this.map.get(child) || null;\n\t}\n\tvalues(): Ref<T>[] {\n\t\treturn Array.from(this.set);\n\t}\n}\n\n/**\n * Map (or dictionary) from string keys to {@link Ref Refs}.\n */\nexport class RefMap<T extends GraphNode = GraphNode> {\n\tmap: { [key: string]: Ref<T> } = {};\n\tconstructor(map?: Record<string, Ref<T>>) {\n\t\tif (map) {\n\t\t\tObject.assign(this.map, map);\n\t\t}\n\t}\n\tset(key: string, child: Ref<T>): void {\n\t\tthis.map[key] = child;\n\t}\n\tdelete(key: string): void {\n\t\tdelete this.map[key];\n\t}\n\tget(key: string): Ref<T> | null {\n\t\treturn this.map[key] || null;\n\t}\n\tkeys(): string[] {\n\t\treturn Object.keys(this.map);\n\t}\n\tvalues(): Ref<T>[] {\n\t\treturn Object.values(this.map);\n\t}\n}\n","/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable @typescript-eslint/ban-types */\nimport {\n\tLiteralKeys,\n\tNullable,\n\tRefCollectionValue,\n\tRefKeys,\n\tRefListKeys,\n\tRefMapKeys,\n\tRefMapValue,\n\tRefSetKeys,\n} from './constants.js';\nimport { BaseEvent, EventDispatcher, GraphNodeEvent } from './event-dispatcher.js';\nimport { Graph } from './graph.js';\nimport { GraphEdge } from './graph-edge.js';\nimport { Ref, RefList, RefMap, RefSet } from './refs.js';\n\n// References:\n// - https://stackoverflow.com/a/70163679/1314762\n// - https://stackoverflow.com/a/70201805/1314762\n\ntype GraphNodeAttributesInternal<Parent extends GraphNode, Attributes extends {}> = {\n\t[Key in keyof Attributes]: Attributes[Key] extends GraphNode\n\t\t? GraphEdge<Parent, Attributes[Key]>\n\t\t: Attributes[Key] extends GraphNode[]\n\t\t? GraphEdge<Parent, Attributes[Key][number]>[]\n\t\t: Attributes[Key] extends { [key: string]: GraphNode }\n\t\t? Record<string, GraphEdge<Parent, Attributes[Key][string]>>\n\t\t: Attributes[Key];\n};\n\nexport const $attributes = Symbol('attributes');\nexport const $immutableKeys = Symbol('immutableKeys');\n\n/**\n * Represents a node in a {@link Graph}.\n */\nexport abstract class GraphNode<Attributes extends {} = {}> extends EventDispatcher<GraphNodeEvent> {\n\tprivate _disposed = false;\n\n\t/**\n\t * Internal graph used to search and maintain references.\n\t * @hidden\n\t */\n\tprotected readonly graph: Graph<GraphNode>;\n\n\t/**\n\t * Attributes (literal values and GraphNode references) associated with this instance. For each\n\t * GraphNode reference, the attributes stores a {@link GraphEdge}. List and Map references are\n\t * stored as arrays and dictionaries of edges.\n\t * @internal\n\t */\n\tprotected readonly [$attributes]: GraphNodeAttributesInternal<this, Attributes>;\n\n\t/**\n\t * Attributes included with `getDefaultAttributes` are considered immutable, and cannot be\n\t * modifed by `.setRef()`, `.copy()`, or other GraphNode methods. Both the edges and the\n\t * properties will be disposed with the parent GraphNode.\n\t *\n\t * Currently, only single-edge references (getRef/setRef) are supported as immutables.\n\t *\n\t * @internal\n\t */\n\tprotected readonly [$immutableKeys]: Set<string>;\n\n\tconstructor(graph: Graph<GraphNode>) {\n\t\tsuper();\n\t\tthis.graph = graph;\n\t\tthis[$immutableKeys] = new Set();\n\t\tthis[$attributes] = this._createAttributes();\n\t}\n\n\t/**\n\t * Returns default attributes for the graph node. Subclasses having any attributes (either\n\t * literal values or references to other graph nodes) must override this method. Literal\n\t * attributes should be given their default values, if any. References should generally be\n\t * initialized as empty (Ref → null, RefList → [], RefMap → {}) and then modified by setters.\n\t *\n\t * Any single-edge references (setRef) returned by this method will be considered immutable,\n\t * to be owned by and disposed with the parent node. Multi-edge references (addRef, removeRef,\n\t * setRefMap) cannot be returned as default attributes.\n\t */\n\tprotected getDefaults(): Nullable<Attributes> {\n\t\treturn {} as Nullable<Attributes>;\n\t}\n\n\t/**\n\t * Constructs and returns an object used to store a graph nodes attributes. Compared to the\n\t * default Attributes interface, this has two distinctions:\n\t *\n\t * 1. Slots for GraphNode<T> objects are replaced with slots for GraphEdge<this, GraphNode<T>>\n\t * 2. GraphNode<T> objects provided as defaults are considered immutable\n\t *\n\t * @internal\n\t */\n\tprivate _createAttributes(): GraphNodeAttributesInternal<this, Attributes> {\n\t\tconst defaultAttributes = this.getDefaults();\n\t\tconst attributes = {} as GraphNodeAttributesInternal<this, Attributes>;\n\t\tfor (const key in defaultAttributes) {\n\t\t\tconst value = defaultAttributes[key] as any;\n\t\t\t// TODO(design): With Ref, RefList, and RefMap types, should users\n\t\t\t// be able to pass them all here? Listeners must be added.\n\t\t\tif (value instanceof GraphNode) {\n\t\t\t\tconst ref = this.graph.createEdge(key, this, value);\n\t\t\t\tref.addEventListener('dispose', () => value.dispose());\n\t\t\t\tthis[$immutableKeys].add(key);\n\t\t\t\tattributes[key] = ref as any;\n\t\t\t} else {\n\t\t\t\tattributes[key] = value as any;\n\t\t\t}\n\t\t}\n\t\treturn attributes;\n\t}\n\n\t/** @internal Returns true if two nodes are on the same {@link Graph}. */\n\tpublic isOnGraph(other: GraphNode): boolean {\n\t\treturn this.graph === other.graph;\n\t}\n\n\t/** Returns true if the node has been permanently removed from the graph. */\n\tpublic isDisposed(): boolean {\n\t\treturn this._disposed;\n\t}\n\n\t/**\n\t * Removes both inbound references to and outbound references from this object. At the end\n\t * of the process the object holds no references, and nothing holds references to it. A\n\t * disposed object is not reusable.\n\t */\n\tpublic dispose(): void {\n\t\tif (this._disposed) return;\n\t\tthis.graph.listChildEdges(this).forEach((edge) => edge.dispose());\n\t\tthis.graph.disconnectParents(this);\n\t\tthis._disposed = true;\n\t\tthis.dispatchEvent({ type: 'dispose' });\n\t}\n\n\t/**\n\t * Removes all inbound references to this object. At the end of the process the object is\n\t * considered 'detached': it may hold references to child resources, but nothing holds\n\t * references to it. A detached object may be re-attached.\n\t */\n\tpublic detach(): this {\n\t\tthis.graph.disconnectParents(this);\n\t\treturn this;\n\t}\n\n\t/**\n\t * Transfers this object's references from the old node to the new one. The old node is fully\n\t * detached from this parent at the end of the process.\n\t *\n\t * @hidden\n\t */\n\tpublic swap(prevValue: GraphNode, nextValue: GraphNode): this {\n\t\tfor (const attribute in this[$attributes]) {\n\t\t\tconst value = this[$attributes][attribute] as Ref | RefList | RefSet | RefMap;\n\t\t\tif (value instanceof GraphEdge) {\n\t\t\t\tconst ref = value as Ref;\n\t\t\t\tif (ref.getChild() === prevValue) {\n\t\t\t\t\tthis.setRef(attribute as any, nextValue, ref.getAttributes());\n\t\t\t\t}\n\t\t\t} else if (value instanceof RefList) {\n\t\t\t\tfor (const ref of value.listRefsByChild(prevValue)) {\n\t\t\t\t\tconst refAttributes = ref.getAttributes();\n\t\t\t\t\tthis.removeRef(attribute as any, prevValue as any);\n\t\t\t\t\tthis.addRef(attribute as any, nextValue as any, refAttributes);\n\t\t\t\t}\n\t\t\t} else if (value instanceof RefSet) {\n\t\t\t\tconst ref = value.getRefByChild(prevValue);\n\t\t\t\tif (ref) {\n\t\t\t\t\tconst refAttributes = ref.getAttributes();\n\t\t\t\t\tthis.removeRef(attribute as any, prevValue as any);\n\t\t\t\t\tthis.addRef(attribute as any, nextValue as any, refAttributes);\n\t\t\t\t}\n\t\t\t} else if (value instanceof RefMap) {\n\t\t\t\tfor (const key of value.keys()) {\n\t\t\t\t\tconst ref = value.get(key)!;\n\t\t\t\t\tif (ref.getChild() === prevValue) {\n\t\t\t\t\t\tthis.setRefMap(attribute as any, key, nextValue as any, ref.getAttributes());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\t/**********************************************************************************************\n\t * Literal attributes.\n\t */\n\n\t/** @hidden */\n\tprotected get<K extends LiteralKeys<Attributes>>(attribute: K): Attributes[K] {\n\t\treturn this[$attributes][attribute] as Attributes[K];\n\t}\n\n\t/** @hidden */\n\tprotected set<K extends LiteralKeys<Attributes>>(attribute: K, value: Attributes[K]): this {\n\t\t(this[$attributes][attribute] as Attributes[K]) = value;\n\t\treturn this.dispatchEvent({ type: 'change', attribute });\n\t}\n\n\t/**********************************************************************************************\n\t * Ref: 1:1 graph node references.\n\t */\n\n\t/** @hidden */\n\tprotected getRef<K extends RefKeys<Attributes>>(attribute: K): (GraphNode & Attributes[K]) | null {\n\t\tconst ref = this[$attributes][attribute] as Ref;\n\t\treturn ref ? (ref.getChild() as GraphNode & Attributes[K]) : null;\n\t}\n\n\t/** @hidden */\n\tprotected setRef<K extends RefKeys<Attributes>>(\n\t\tattribute: K,\n\t\tvalue: (GraphNode & Attributes[K]) | null,\n\t\tattributes?: Record<string, unknown>,\n\t): this {\n\t\tif (this[$immutableKeys].has(attribute as string)) {\n\t\t\tthrow new Error(`Cannot overwrite immutable attribute, \"${attribute as string}\".`);\n\t\t}\n\n\t\tconst prevRef = this[$attributes][attribute] as Ref;\n\t\tif (prevRef) prevRef.dispose(); // TODO(cleanup): Possible duplicate event.\n\n\t\tif (!value) return this;\n\n\t\tconst ref = this.graph.createEdge(attribute as string, this, value, attributes);\n\t\tref.addEventListener('dispose', () => {\n\t\t\tdelete this[$attributes][attribute];\n\t\t\tthis.dispatchEvent({ type: 'change', attribute });\n\t\t});\n\t\t(this[$attributes][attribute] as Ref) = ref;\n\n\t\treturn this.dispatchEvent({ type: 'change', attribute });\n\t}\n\n\t/**********************************************************************************************\n\t * RefList: 1:many graph node references.\n\t */\n\n\t/** @hidden */\n\tprotected listRefs<K extends RefListKeys<Attributes> | RefSetKeys<Attributes>>(\n\t\tattribute: K,\n\t): RefCollectionValue<Attributes[K]>[] {\n\t\tconst refs = this.assertRefList(attribute);\n\t\treturn refs.values().map((ref) => ref.getChild()) as RefCollectionValue<Attributes[K]>[];\n\t}\n\n\t/** @hidden */\n\tprotected addRef<K extends RefListKeys<Attributes> | RefSetKeys<Attributes>>(\n\t\tattribute: K,\n\t\tvalue: RefCollectionValue<Attributes[K]>,\n\t\tattributes?: Record<string, unknown>,\n\t): this {\n\t\tconst ref = this.graph.createEdge(attribute as string, this, value, attributes);\n\n\t\tconst refs = this.assertRefList(attribute);\n\t\trefs.add(ref);\n\n\t\tref.addEventListener('dispose', () => {\n\t\t\trefs.remove(ref);\n\t\t\tthis.dispatchEvent({ type: 'change', attribute });\n\t\t});\n\n\t\treturn this.dispatchEvent({ type: 'change', attribute });\n\t}\n\n\t/** @hidden */\n\tprotected removeRef<K extends RefListKeys<Attributes> | RefSetKeys<Attributes>>(\n\t\tattribute: K,\n\t\tvalue: RefCollectionValue<Attributes[K]>,\n\t): this {\n\t\tconst refs = this.assertRefList(attribute);\n\n\t\tif (refs instanceof RefList) {\n\t\t\tfor (const ref of refs.removeChild(value)) {\n\t\t\t\tref.dispose();\n\t\t\t}\n\t\t} else {\n\t\t\tconst ref = refs.removeChild(value);\n\t\t\tif (ref) ref.dispose();\n\t\t}\n\n\t\treturn this;\n\t}\n\n\t/** @hidden */\n\tprivate assertRefList<K extends RefListKeys<Attributes> | RefSetKeys<Attributes>>(attribute: K): RefList | RefSet {\n\t\tconst list = this[$attributes][attribute];\n\n\t\tif (list instanceof RefList || list instanceof RefSet) {\n\t\t\treturn list;\n\t\t}\n\n\t\t// TODO(v3) Remove warning.\n\t\tthrow new Error(`Expected RefList or RefSet for attribute \"${attribute as string}\"`);\n\t}\n\n\t/**********************************************************************************************\n\t * RefMap: Named 1:many (map) graph node references.\n\t */\n\n\t/** @hidden */\n\tprotected listRefMapKeys<K extends RefMapKeys<Attributes>>(attribute: K): string[] {\n\t\treturn this.assertRefMap(attribute).keys();\n\t}\n\n\t/** @hidden */\n\tprotected listRefMapValues<K extends RefMapKeys<Attributes>, V extends RefMapValue<Attributes[K]>>(\n\t\tattribute: K,\n\t): V[] {\n\t\treturn this.assertRefMap(attribute)\n\t\t\t.values()\n\t\t\t.map((ref: any) => ref.getChild());\n\t}\n\n\t/** @hidden */\n\tprotected getRefMap<K extends RefMapKeys<Attributes>, V extends RefMapValue<Attributes[K]>>(\n\t\tattribute: K,\n\t\tkey: string,\n\t): V | null {\n\t\tconst refMap = this.assertRefMap(attribute);\n\t\tconst ref = refMap.get(key as string);\n\t\treturn ref ? (ref.getChild() as V) : null;\n\t}\n\n\t/** @hidden */\n\tprotected setRefMap<K extends RefMapKeys<Attributes>, V extends RefMapValue<Attributes[K]>>(\n\t\tattribute: K,\n\t\tkey: string,\n\t\tvalue: V | null,\n\t\tmetadata?: Record<string, unknown>,\n\t): this {\n\t\tconst refMap = this.assertRefMap(attribute);\n\n\t\tconst prevRef = refMap.get(key as string);\n\t\tif (prevRef) prevRef.dispose(); // TODO(cleanup): Possible duplicate event.\n\n\t\tif (!value) return this;\n\n\t\tmetadata = Object.assign(metadata || {}, { key: key });\n\t\tconst ref = this.graph.createEdge(attribute as string, this, value, { ...metadata, key });\n\t\tref.addEventListener('dispose', () => {\n\t\t\trefMap.delete(key as string);\n\t\t\tthis.dispatchEvent({ type: 'change', attribute, key });\n\t\t});\n\t\trefMap.set(key as string, ref);\n\n\t\treturn this.dispatchEvent({ type: 'change', attribute, key });\n\t}\n\n\t/** @hidden */\n\tprivate assertRefMap<K extends RefMapKeys<Attributes>>(attribute: K): RefMap {\n\t\tconst map = this[$attributes][attribute];\n\n\t\tif (map instanceof RefMap) {\n\t\t\treturn map;\n\t\t}\n\n\t\t// TODO(v3) Remove warning.\n\t\tthrow new Error(`Expected RefMap for attribute \"${attribute as string}\"`);\n\t}\n\n\t/**********************************************************************************************\n\t * Events.\n\t */\n\n\t/**\n\t * Dispatches an event on the GraphNode, and on the associated\n\t * Graph. Event types on the graph are prefixed, `\"node:[type]\"`.\n\t */\n\tdispatchEvent(event: BaseEvent): this {\n\t\tsuper.dispatchEvent({ ...event, target: this });\n\t\tthis.graph.dispatchEvent({ ...event, target: this, type: `node:${event.type}` });\n\t\treturn this;\n\t}\n}\n"],"names":["EventDispatcher","_listeners","addEventListener","type","listener","listeners","undefined","indexOf","push","removeEventListener","listenerArray","index","splice","dispatchEvent","event","array","slice","i","l","length","call","dispose","key","GraphEdge","constructor","_name","_parent","_child","_attributes","_disposed","isOnGraph","Error","getName","getParent","getChild","setChild","child","getAttributes","target","isDisposed","Graph","_emptySet","Set","_edges","_parentEdges","Map","_childEdges","listEdges","Array","from","listParentEdges","node","get","listParents","map","edge","listChildEdges","listChildren","disconnectParents","filter","edges","forEach","createEdge","name","a","b","attributes","_registerEdge","add","parent","has","set","_removeEdge","delete","RefList","refs","list","ref","remove","removeChild","listRefsByChild","values","RefSet","getRefByChild","RefMap","Object","assign","keys","$attributes","Symbol","$immutableKeys","GraphNode","graph","_createAttributes","getDefaults","defaultAttributes","value","other","detach","swap","prevValue","nextValue","attribute","setRef","refAttributes","removeRef","addRef","setRefMap","getRef","prevRef","listRefs","assertRefList","listRefMapKeys","assertRefMap","listRefMapValues","getRefMap","refMap","metadata"],"mappings":"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"}